# 音乐文档

> 项目适配说明（2026-02-04）
> - 搜索与解析默认通过 LiSync（手机端）完成；手表直连模式在代码中关闭（`WATCH_DIRECT_ENABLED = false`）。
> - 播放引擎使用 `@system.audio`，全局播放状态在 `src/app.ux` 管理。
> - 本地音乐保存路径：`internal://files/music/`；数据库：`internal://files/app_db.json`。
> - 支持收藏与本地列表；下载流程见 `src/common/download.js` 与 `pages/download`。
# LX Music 源中转服务器 - API 文档

## 基础信息

* **服务器地址**: `http://127.0.0.1:8082`
* **管理员密码**: `mindrift\\\_2026\\\_yyds\\\_music`
* **Content-Type**: `application/json`

---

## 一、公开接口 (无需认证)

### 1暂无---

### 2\. 解析音乐

```
POST /resolve
Content-Type: application/json

{
  "action": "musicUrl",    // 可选: musicUrl | lyric | pic (默认 musicUrl)
  "source": "tx",          // 音源: kw | kg | tx | wy | mg
  "quality": "320k",       // 音质 (仅 musicUrl 需要)
  "musicInfo": {
    "songmid": "003OUlho2HcRHC"  // 或 "hash": "..."
  },
  "nocache": false         // 可选: true=跳过缓存
}
```

**响应 (musicUrl)**:

```json
{
  "url": "https://xxx.com/xxx.flac",
  "data": "https://xxx.com/xxx.flac"
}
```

**响应 (lyric)**:

**网易云 (wy) / 酷狗 (kg)**:
```json
{
  "data": {
    "lrc": {
      "lyric": "[00:00.000] 作词 : Lucky小爱\n[00:01.000] 作曲 : Lucky小爱\n[00:30.542]故事的小黄花\n..."
    }
  }
}
```

**腾讯音乐 (tx)**:
```json
{
  "data": {
    "lyric": "[ti:告白气球]\n[ar:周杰伦]\n[al:周杰伦的床边故事]\n[00:23.59]塞纳河畔 左岸的咖啡\n..."
  }
}
```

**响应 (pic)**:

```json
{
  "data": "https://xxx.com/cover.jpg"
}
```

---

### 3\. 聚合搜索

```
GET /search?keyword=周杰伦\\\&page=1\\\&limit=20
```

**参数**:

\*\*参数\*\*:

\\\*\\\*参数\\\*\\\*:
| 参数 | 必填 | 默认值 | 说明 |
|------|------|--------|------|
| keyword / w | 是 | - | 搜索关键词 |
| page | 否 | 1 | 页码 |
| limit | 否 | 20 | 每页数量 |

**响应示例**:

```json
{
  "code": 0,
  "data": \\\[
    {
      "source": "tx",
      "id": "003OUlho2HcRHC",
      "title": "晴天",
      "artist": "周杰伦"
    },
    {
      "source": "wy",
      "id": "2652820720",
      "title": "晴天(深情版)",
      "artist": "Lucky小爱"
    },
    {
      "source": "kg",
      "id": "b160ccbec52c36a0286ece8d865dc641",
      "title": "什么玩意",
      "artist": "1n0uT"
    }
  ]
}
```

**说明**: 同时搜索腾讯音乐(TX)、网易云音乐(WY)、酷狗音乐(KG)。

---

### 4\. 随机播放 (客户端用)

```
GET /random
```

**响应**: `302 Redirect` 到随机 MP3/FLAC URL

**示例**:

```bash
curl -L http://127.0.0.1:8082/random
# 重定向到: https://ws.stream.qqmusic.qq.com/M800003xxx.mp3
```

---

## 二、管理接口 (需要认证)

所有管理接口需在请求头中添加认证:

```
X-Auth: mindrift\\\_2026\\\_yyds\\\_music
```

---

### 1\. 获取服务器状态

```
GET /admin/stats
```

**响应示例**:

```json
{
  "uptime": "2h 30m 15s",
  "cacheSize": 150,
  "logCount": 234,
  "memory": "128 MB",
  "rotation": {
    "kw": 1,
    "tx": 0,
    "wy": 2
  }
}
```

---

### 2\. 获取日志

```
GET /admin/logs
```

**响应示例**:

```json
\\\[
  {
    "time": "2026-01-10T14:00:00.000Z",
    "type": "log",
    "msg": "Script loaded: 陵川.js"
  },
  {
    "time": "2026-01-10T14:00:01.000Z",
    "type": "error",
    "msg": "Request timeout"
  }
]
```

**说明**: 最多保留 500 条日志。

---

### 3\. 获取缓存列表

```
GET /admin/cache
```

**响应示例**:

```json
\\\[
  {
    "key": "tx:003OUlho2HcRHC:musicUrl:320k",
    "data": "https://xxx.com/xxx.flac",
    "ttl": 3600,
    "provider": "陵川.js"
  }
]
```

---

### 4\. 清空所有缓存

```
DELETE /admin/cache
```

**响应**:

```json
{
  "success": true,
  "count": 150
}
```

---

### 5\. 删除单个缓存

```
DELETE /admin/cache/:key
# 或 base64 编码: DELETE /admin/cache/dGg6MDM5OUx1MjhIMGNSSFM6bXVzaWNVUkw6MzIway==
```

**参数**: key 需 URL 编码或 base64 编码

**响应**:

```json
{ "success": true }
```

---

### 6\. 随机播放 (管理端)

```
GET /admin/cache/random
```

**响应**:

```json
{
  "url": "https://xxx.com/xxx.flac",
  "ttl": 3600
}
```

---

### 7\. 获取脚本列表

```
GET /admin/scripts
```

**响应示例**:

```json
\\\[
  {
    "id": "陵川.js",
    "name": "聆川(赞助版)",
    "version": "v12",
    "author": "guoyue2010"
  },
  {
    "id": "聚合.js",
    "name": "聚合API接口",
    "version": "3",
    "author": "lerd"
  }
]
```

---

### 8\. 上传脚本

```
POST /admin/scripts
Content-Type: multipart/form-data

Body: file = 脚本文件.js
```

**响应**:

```json
{ "success": true }
```

**说明**: 上传后自动重新加载所有脚本。

---

### 9\. 删除脚本

```
DELETE /admin/scripts/:filename
```

**响应**:

```json
{ "success": true }
```

---

## 三、页面路由

| 路径 | 功能 |
|------|------|
| `/` | Web 管理面板 (需登录) |
| 其他 | 返回 index.html (SPA 路由) |

---

## 四、错误响应

| 状态码 | 说明 | 示例 |
|--------|------|------|
| 400 | 参数错误 | `{"error": "Keyword is required"}` |
| 401 | 未授权 | `{"error": "Unauthorized"}` |
| 404 | 资源不存在 | `{"error": "Source not supported"}` |
| 500 | 服务器错误 | `{"error": "All providers failed"}` |

---

## 九、客户端使用示例

### 搜索并获取音乐

```javascript
// 1. 搜索音乐
const searchRes = await fetch('http://127.0.0.1:8082/search?keyword=周杰伦');
const searchData = await searchRes.json();
const song = searchData.data\\\[0]; // 取第一个结果

// 2. 获取播放链接
const resolveRes = await fetch('http://127.0.0.1:8082/resolve', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        action: 'musicUrl',
        source: song.source,
        quality: '320k',
        musicInfo: { songmid: song.id }
    })
});
const resolveData = await resolveRes.json();
console.log('播放地址:', resolveData.url);
```

### 随机播放

```javascript
// 方式1: 直接跳转
window.open('http://127.0.0.1:8082/random', '\\\_blank');

// 方式2: 获取 URL 后播放
const res = await fetch('http://127.0.0.1:8082/admin/cache/random', {
    headers: { 'X-Auth': 'mindrift\\\_2026\\\_yyds\\\_music' }
});
const data = await res.json();
const audio = new Audio(data.url);
audio.play();
```

### 获取歌词

```javascript
const res = await fetch('http://127.0.0.1:8082/resolve', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        action: 'lyric',
        source: 'wy',
        musicInfo: { songmid: '2652820720' }
    })
});
const data = await res.json();
console.log('歌词:', data.data.lrc.lyric);
```

---

## 六、音源标识

| 标识 | 平台 | 支持 Action |
|------|------|-------------|
| kw | 酷我音乐 | musicUrl, pic |
| kg | 酷狗音乐 | musicUrl, pic, lyric |
| tx | 腾讯音乐 (QQ音乐) | musicUrl, pic, lyric |
| wy | 网易云音乐 | musicUrl, pic, lyric |
| mg | 咪咕音乐 | musicUrl, pic |

---

## 七、歌词格式说明

### 网易云音乐 (wy) / 酷狗音乐 (kg)
返回格式:
```json
{
  "data": {
    "lrc": {
      "lyric": "[00:00.000] 作词 : ...\n[00:01.000] 作曲 : ...\n[00:30.542]故事的小黄花\n..."
    }
  }
}
```

### 腾讯音乐 (tx)
返回格式:
```json
{
  "data": {
    "lyric": "[ti:歌曲名]\n[ar:歌手]\n[al:专辑]\n[00:00.00]歌词内容\n..."
  }
}
```

**前端处理建议**:
- 网易云/酷狗: `data.lrc.lyric`
- 腾讯音乐: `data.lyric`

---

## 八、支持的音质

| 音质 | 说明 |
|------|------|
| 128k | 标准品质 |
| 320k | 高品质 |
| flac | 无损 |
| flac24bit | 高解析无损 |
| hires | Hi-Res |
| atmos | 杜比全景声 |
| master | Master 音质 |

**注意**: 不同音源支持的音质可能不同。


